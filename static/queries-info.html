{% extends "base.html" %}

{% block content %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Queries-Info</title>
    <link href="https://cdn.datatables.net/2.0.6/css/dataTables.dataTables.css">
    <link href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.dataTables.css">
    <link rel="stylesheet" href="/static/css/queries_styles.css"> <!-- Подключение CSS -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="button-container">
        <a href="{{ url_for('show_profile', username=user.username) }}" class="back-to-menu">Back to profile</a>
    {% if user.role_info.access_queries_full or user.role_info.access_queries_update %}
        <input type="button" value="Update Data Query" onclick="sendRequest('{{ url_for('load_queries_script') }}')">
    {% endif %}
        <label for="last_update_date">Last Update Date: {{ last_update_date }}</label>
        <label id="last_date" for="last_update_date" title={{last_date}}>Данные есть до: {{ last_date }}</label>
        <input type="number" id="days" placeholder="Days" min="1" max="13">
        <input type="button" value="Delete Data for the Last" onclick="deleteDataForLast('{{ url_for('delete_query') }}');">
    </div>

    <!-- Existing filters and buttons -->
    {% if user.role_info.access_queries_full or user.role_info.access_queries_view or user.role_info.access_queries_filter%}
        <input type="date" id="start_date">
        <input type="date" id="end_date">
    {% endif %}
    {% if user.role_info.access_queries_full or user.role_info.access_queries_filter %}
        <input type="text" id="search_field" style="width: 250px">
        <label for="input_sort">Отсортировать?</label>
        <input type="checkbox" id="input_sort">
        <label for="input_desc">По убыванию?</label>
        <input type="checkbox" id="input_desc">
    {% endif %}
    {% if user.role_info.access_queries_full or user.role_info.access_queries_view or user.role_info.access_queries_filter %}
        <input type="button" value="Отфильтровать" onclick="UpdateTable();">
    {% endif %}
    {% if user.role_info.access_queries_full or user.role_info.access_queries_export %}
        <input type="button" value="Excel" onclick="generateExcel('{{ url_for('generate_excel_query')}}');">
        <input type="button" value="Csv" onclick="generateCsv('{{ url_for('generate_csv_query')}}');">
    {% endif %}
    {% if user.role_info.access_queries_full or user.role_info.access_queries_sum %}
        <input type="button" value="Вычислить суммы" onclick="getTotalSum('{{ url_for('get_total_sum')}}');">
    {% endif %}
    {% if user.role_info.access_queries_full or user.role_info.access_queries_sum %}
        <input type="button" value="Скрыть график" id="hideGraphBtn" style="display: none;" onclick="toggleGraph();">
        <canvas id="myChart" width="600" height="100" style="display: none;"></canvas>
    {% endif %}
    {% if user.role_info.access_queries_full or user.role_info.access_queries_view %}
    <table id="example" class="display nowrap" style="width:100%;">
        <thead id="thead_t">
            <tr id="head_t">
                <!-- Table headers will be inserted here dynamically -->
            </tr>
        </thead>
        <tbody id="body_t">
            <!-- Table body will be inserted here dynamically -->
        </tbody>
    </table>

    <div class="pagination">
        <button id="prev" onclick="PrevPage()">Previous</button>
        <button id="cur" disabled>Current</button>
        <button id="next" onclick="NextPage()">Next</button>
    </div>
    {% endif %}

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <script src="https://cdn.datatables.net/2.0.6/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.dataTables.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.print.min.js"></script>


<script>
    var state = null;
    var global_date = null;
    var metric_type = null;
    var state_type = "date";

    var prev_start_date = null;
    var prev_end_date = null;
    var prev_search_field = "";

    let chartInstance = null; // Глобальная переменная для хранения экземпляра графика

    function getDayOfWeek(dateString) {
      const dateParts = dateString.split("-");
      const year = parseInt(dateParts[0], 10);
      const month = parseInt(dateParts[1], 10) - 1;
      const day = parseInt(dateParts[2], 10);

      const date = new Date(year, month, day);
      const dayOfWeek = date.getDay();

      switch (dayOfWeek) {
        case 0:
          return "Воскресенье";
        case 1:
          return "Понедельник";
        case 2:
          return "Вторник";
        case 3:
          return "Среда";
        case 4:
          return "Четверг";
        case 5:
          return "Пятница";
        case 6:
          return "Суббота";
        default:
          return "Invalid date";
          }
        }
    function getDate(minus_day) {
        var today = new Date();
        var twoWeeksAgo = new Date(today.getTime() - (minus_day * 24 * 60 * 60 * 1000));
        var ddTwoWeeksAgo = String(twoWeeksAgo.getDate()).padStart(2, '0');
        var mmTwoWeeksAgo = String(twoWeeksAgo.getMonth() + 1).padStart(2, '0');
        var yyyyTwoWeeksAgo = twoWeeksAgo.getFullYear();

        var twoWeeksAgoDate = yyyyTwoWeeksAgo + '-' + mmTwoWeeksAgo + '-' + ddTwoWeeksAgo;
        return twoWeeksAgoDate
    }

    function IncrementDate(date, minus_day) {
        var today = new Date(date);
        var twoWeeksAgo = new Date(today.getTime() + (minus_day * 24 * 60 * 60 * 1000));
        var ddTwoWeeksAgo = String(twoWeeksAgo.getDate()).padStart(2, '0');
        var mmTwoWeeksAgo = String(twoWeeksAgo.getMonth() + 1).padStart(2, '0');
        var yyyyTwoWeeksAgo = twoWeeksAgo.getFullYear();

        var twoWeeksAgoDate = yyyyTwoWeeksAgo + '-' + mmTwoWeeksAgo + '-' + ddTwoWeeksAgo;
        return twoWeeksAgoDate
    }


    function calculateDays() {
        var start_date = new Date(document.getElementById('start_date').value);
        var end_date = new Date(document.getElementById('end_date').value);

        var diffTime = Math.abs(end_date - start_date);
        var diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        return diffDays;
    }

    function SetDatePage() {
        // Set today date in the input for start date
        document.getElementById('end_date').value = getDate(0);

        // Set the default value of the second input to two weeks ago
        document.getElementById('start_date').value = getDate(14);
    }


    function SetDataTable() {

        let row = document.getElementById("head_t");

        document.getElementById("prev").innerHTML = 0;
        document.getElementById("prev").disabled = true;
        document.getElementById("cur").innerHTML = 1;
        document.getElementById("next").innerHTML = 2;

        var nameCell = document.createElement('td');
        nameCell.textContent = "query";
        row.appendChild(nameCell);
        var nameCell = document.createElement('td');
        nameCell.textContent = "result"; // Добавляем основной текст
        var lineBreak = document.createElement('br'); // Создаем элемент <br> для переноса строки
        nameCell.appendChild(lineBreak); // Добавляем перенос строки
        nameCell.appendChild(document.createTextNode("None")); // Добавляем текст "None"
        row.appendChild(nameCell); // Добавляем ячейку в строку

        let pButton = document.createElement('button');
            pButton.style.width = '20px';  // Ширина кнопки
            pButton.style.height = '20px'; // Высота кнопки
            pButton.style.fontSize = '12px'; // Размер шрифта
            pButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            pButton.innerHTML = "P";
            let kButton = document.createElement('button');
            kButton.style.width = '20px';  // Ширина кнопки
            kButton.style.height = '20px'; // Высота кнопки
            kButton.style.fontSize = '12px'; // Размер шрифта
            kButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            kButton.innerHTML = "K";
            let rButton = document.createElement('button');
            rButton.style.width = '20px';  // Ширина кнопки
            rButton.style.height = '20px'; // Высота кнопки
            rButton.style.fontSize = '12px'; // Размер шрифта
            rButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            rButton.innerHTML = "R↓";
            let cButton = document.createElement('button');
            cButton.style.width = '20px';  // Ширина кнопки
            cButton.style.height = '20px'; // Высота кнопки
            cButton.style.fontSize = '12px'; // Размер шрифта
            cButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            cButton.innerHTML = "C";

            pButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], pButton);
                state_type = "result";

                if (this.innerHTML === "P") {
                    this.innerHTML = "P↓";
                    state = "decrease";
                } else if (this.innerHTML === "P↓") {
                    this.innerHTML = "P↑";
                    state = "increase";
                } else if (this.innerHTML === "P↑") {
                    this.innerHTML = "P";
                    state = null;
                }

                metric_type = "P";

                UpdateTable();
            });

            kButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], kButton);
                state_type = "result";

                if (this.innerHTML === "K") {
                    this.innerHTML = "K↓";
                    state = "decrease";
                } else if (this.innerHTML === "K↓") {
                    this.innerHTML = "K↑";
                    state = "increase";
                } else if (this.innerHTML === "K↑") {
                    this.innerHTML = "K";
                    state = null;
                }

                metric_type = "K";

                UpdateTable();
            });

            rButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], rButton);
                state_type = "result";

                if (this.innerHTML === "R") {
                    this.innerHTML = "R↓";
                    state = "decrease";
                } else if (this.innerHTML === "R↓") {
                    this.innerHTML = "R↑";
                    state = "increase";
                } else if (this.innerHTML === "R↑") {
                    this.innerHTML = "R";
                    state = null;
                }

                metric_type = "R";

                UpdateTable();
            });

            cButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], cButton);
                state_type = "result";

                if (this.innerHTML === "C") {
                    this.innerHTML = "C↓";
                    state = "decrease";
                } else if (this.innerHTML === "C↓") {
                    this.innerHTML = "C↑";
                    state = "increase";
                } else if (this.innerHTML === "C↑") {
                    this.innerHTML = "C";
                    state = null;
                }

                metric_type = "C";

                UpdateTable();
            });

            let buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex'; // Выравнивание кнопок в одну строку
            buttonContainer.style.gap = '5px'; // Расстояние между кнопками

            // Добавляем кнопки в контейнер
            buttonContainer.appendChild(pButton);
            buttonContainer.appendChild(kButton);
            buttonContainer.appendChild(rButton);
            buttonContainer.appendChild(cButton);

// Добавляем контейнер в ячейку
            nameCell.appendChild(buttonContainer);

            row.appendChild(nameCell);        
            
            columns = [
            {"title": "query"},
            {"title": "result"},
        ]
        
        amount = calculateDays();

        for (let i = amount; i >= 0; i--) {  // Используем `let` вместо `var`

            let date = IncrementDate(document.getElementById('start_date').value, i);  // Используем `let`
            columns.push({"title": date});

            let nameCell = document.createElement('td');
            nameCell.innerHTML = getDayOfWeek(date) + "<br>" + date;
            row.appendChild(nameCell);

            let pButton = document.createElement('button');
            pButton.style.width = '20px';  // Ширина кнопки
            pButton.style.height = '20px'; // Высота кнопки
            pButton.style.fontSize = '12px'; // Размер шрифта
            pButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            pButton.innerHTML = "P";
            let kButton = document.createElement('button');
            kButton.style.width = '20px';  // Ширина кнопки
            kButton.style.height = '20px'; // Высота кнопки
            kButton.style.fontSize = '12px'; // Размер шрифта
            kButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            kButton.innerHTML = "K";
            let rButton = document.createElement('button');
            rButton.style.width = '20px';  // Ширина кнопки
            rButton.style.height = '20px'; // Высота кнопки
            rButton.style.fontSize = '12px'; // Размер шрифта
            rButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            rButton.innerHTML = "R";
            let cButton = document.createElement('button');
            cButton.style.width = '20px';  // Ширина кнопки
            cButton.style.height = '20px'; // Высота кнопки
            cButton.style.fontSize = '12px'; // Размер шрифта
            cButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            cButton.innerHTML = "C";

            pButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], pButton);

                if (this.innerHTML === "P") {
                    this.innerHTML = "P↓";
                    state = "decrease";
                } else if (this.innerHTML === "P↓") {
                    this.innerHTML = "P↑";
                    state = "increase";
                } else if (this.innerHTML === "P↑") {
                    this.innerHTML = "P";
                    state = null;
                }

                global_date = date;
                metric_type = "P";

                UpdateTable();
            });

            kButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], kButton);

                if (this.innerHTML === "K") {
                    this.innerHTML = "K↓";
                    state = "decrease";
                } else if (this.innerHTML === "K↓") {
                    this.innerHTML = "K↑";
                    state = "increase";
                } else if (this.innerHTML === "K↑") {
                    this.innerHTML = "K";
                    state = null;
                }

                global_date = date;
                metric_type = "K";

                UpdateTable();
            });

            rButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], rButton);

                if (this.innerHTML === "R") {
                    this.innerHTML = "R↓";
                    state = "decrease";
                } else if (this.innerHTML === "R↓") {
                    this.innerHTML = "R↑";
                    state = "increase";
                } else if (this.innerHTML === "R↑") {
                    this.innerHTML = "R";
                    state = null;
                }

                global_date = date;
                metric_type = "R";

                UpdateTable();
            });

            cButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], cButton);

                if (this.innerHTML === "C") {
                    this.innerHTML = "C↓";
                    state = "decrease";
                } else if (this.innerHTML === "C↓") {
                    this.innerHTML = "C↑";
                    state = "increase";
                } else if (this.innerHTML === "C↑") {
                    this.innerHTML = "C";
                    state = null;
                }

                global_date = date;
                metric_type = "C";

                UpdateTable();
            });

            // Функция для сброса состояния всех кнопок
            function resetButtons(buttons, activeButton) {
                state_type = "date";
                buttons.forEach(function(button) {
                    if (button !== activeButton) {
                        button.innerHTML = button.innerHTML.charAt(0); // Сброс до "P", "K", "R", "C"
                    }
                });
            }

            let buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex'; // Выравнивание кнопок в одну строку
            buttonContainer.style.gap = '5px'; // Расстояние между кнопками

            // Добавляем кнопки в контейнер
            buttonContainer.appendChild(pButton);
            buttonContainer.appendChild(kButton);
            buttonContainer.appendChild(rButton);
            buttonContainer.appendChild(cButton);

// Добавляем контейнер в ячейку
            nameCell.appendChild(buttonContainer);

            row.appendChild(nameCell);
        }

        // Сортировка по показам по умолчанию
        state_type = "result";                
        state = "decrease";
        metric_type = "R";

        prev_start_date = document.getElementById('start_date') ? document.getElementById('start_date').value : null;
        prev_end_date = document.getElementById('end_date') ? document.getElementById('end_date').value : null;
        prev_search_text = document.getElementById("search_field") ? document.getElementById("search_field").value : null;

        var url = "{{ url_for('get_queries') }}";
        var params = {
            length: 50, // количество отображаемых элементов
            start: 0, // номер страницы
            start_date: document.getElementById('start_date') ? document.getElementById('start_date').value : null, // Дата начала поиска
            end_date:document.getElementById('end_date') ? document.getElementById('end_date').value : null, // Дата окончания поиска
            amount: calculateDays(),
            search_text: document.getElementById("search_field") ? document.getElementById("search_field").value : '',
            sort_result: document.getElementById("input_sort") ? document.getElementById("input_sort").checked : false,
            sort_desc: document.getElementById("input_desc") ? document.getElementById("input_desc").checked : false,
            button_date: global_date,
            button_state: state,
            metric_type: metric_type,
            state_type: state_type,
        };

        fetch(url, {
            method: "POST",
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify(params)
            // body: formData
        })
            .then(response => response.json())
            .then(data => {
                // Обработка ответа
                data = data.data;
                // Добавление данных в таблицу
                var table = $('#body_t');
                empty = `<div style='height: 55px; width: 100px; margin: 0px; padding: 0px; background-color: #B9BDBC'>
            <span style='font-size: 18px'><span style='color:red'>NAN</span></span><br>
            <span style='font-size: 10px'>Клики</span><span style='font-size: 10px; margin-left: 10px'>CTR <span style='color:red'>NAN%</span></span><br>
            <span style='font-size: 10px'><span style='color:red'>NAN</span></span> <span style='font-size: 10px; margin-left: 30px'>R <span style='color:red'>NAN%</span></span>
            </div>`
                for (i = 0; i < 50; i++) {
                    var newRow = '<tr>';
                    $.each(columns, function (index_c, cell) {
                        if (data[i][columns[index_c]["title"]]) {
                            newRow += '<td>' + data[i][columns[index_c]["title"]] + '</td>';
                        } else {
                            newRow += '<td>' + empty + '</td>';
                        }
                    });
                    newRow += '</tr>';
                    table.append(newRow);
                }

            })
            .catch(error => {
                // Обработка ошибки
                console.error("Error:", error);
            });

        

    }

    function UpdateTable() {
        console.log(state_type, state)
        let row = document.getElementById("head_t");
        row.innerHTML = "";

        var nameCell = document.createElement('td');
        nameCell.textContent = "query";
        row.appendChild(nameCell);
        var nameCell = document.createElement('td');
        nameCell.textContent = "result"; // Добавляем основной текст
        var lineBreak = document.createElement('br'); // Создаем элемент <br> для переноса строки
        nameCell.appendChild(lineBreak); // Добавляем перенос строки
        nameCell.appendChild(document.createTextNode("None")); // Добавляем текст "None"
        row.appendChild(nameCell); // Добавляем ячейку в строку

        let pButton = document.createElement('button');
            pButton.style.width = '20px';  // Ширина кнопки
            pButton.style.height = '20px'; // Высота кнопки
            pButton.style.fontSize = '12px'; // Размер шрифта
            pButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            pButton.innerHTML = "P";
            let kButton = document.createElement('button');
            kButton.style.width = '20px';  // Ширина кнопки
            kButton.style.height = '20px'; // Высота кнопки
            kButton.style.fontSize = '12px'; // Размер шрифта
            kButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            kButton.innerHTML = "K";
            let rButton = document.createElement('button');
            rButton.style.width = '20px';  // Ширина кнопки
            rButton.style.height = '20px'; // Высота кнопки
            rButton.style.fontSize = '12px'; // Размер шрифта
            rButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            rButton.innerHTML = "R";
            let cButton = document.createElement('button');
            cButton.style.width = '20px';  // Ширина кнопки
            cButton.style.height = '20px'; // Высота кнопки
            cButton.style.fontSize = '12px'; // Размер шрифта
            cButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            cButton.innerHTML = "C";
        
            if (state === "decrease" && state_type == "result") {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type + "↓";
                } 
            } else if (state === "increase" && state_type == "result") {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type + "↑";
                } 
            } else {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type;
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type;
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type;
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type;
                } 
                }

                pButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], pButton);
                state_type = "result";

                if (this.innerHTML === "P") {
                    this.innerHTML = "P↓";
                    state = "decrease";
                } else if (this.innerHTML === "P↓") {
                    this.innerHTML = "P↑";
                    state = "increase";
                } else if (this.innerHTML === "P↑") {
                    this.innerHTML = "P";
                    state = null;
                }

                metric_type = "P";

                UpdateTable();
            });

            kButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], kButton);
                state_type = "result";

                if (this.innerHTML === "K") {
                    this.innerHTML = "K↓";
                    state = "decrease";
                } else if (this.innerHTML === "K↓") {
                    this.innerHTML = "K↑";
                    state = "increase";
                } else if (this.innerHTML === "K↑") {
                    this.innerHTML = "K";
                    state = null;
                }

                metric_type = "K";

                UpdateTable();
            });

            rButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], rButton);
                state_type = "result";

                if (this.innerHTML === "R") {
                    this.innerHTML = "R↓";
                    state = "decrease";
                } else if (this.innerHTML === "R↓") {
                    this.innerHTML = "R↑";
                    state = "increase";
                } else if (this.innerHTML === "R↑") {
                    this.innerHTML = "R";
                    state = null;
                }

                metric_type = "R";

                UpdateTable();
            });

            cButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], cButton);
                state_type = "result";

                if (this.innerHTML === "C") {
                    this.innerHTML = "C↓";
                    state = "decrease";
                } else if (this.innerHTML === "C↓") {
                    this.innerHTML = "C↑";
                    state = "increase";
                } else if (this.innerHTML === "C↑") {
                    this.innerHTML = "C";
                    state = null;
                }

                metric_type = "C";

                UpdateTable();
            });

            let buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex'; // Выравнивание кнопок в одну строку
            buttonContainer.style.gap = '5px'; // Расстояние между кнопками

            // Добавляем кнопки в контейнер
            buttonContainer.appendChild(pButton);
            buttonContainer.appendChild(kButton);
            buttonContainer.appendChild(rButton);
            buttonContainer.appendChild(cButton);

// Добавляем контейнер в ячейку
            nameCell.appendChild(buttonContainer);

            row.appendChild(nameCell);
        
        columns = [
            {"title": "query"},
            {"title": "result"},
        ]

        amount = calculateDays();

        for (let i = amount; i >= 0; i--) {
            let date = IncrementDate(document.getElementById('start_date').value, i);
            columns.push({"title": date});
            let nameCell = document.createElement('td');
            nameCell.innerHTML = getDayOfWeek(IncrementDate(document.getElementById('start_date').value, i)) + "<br>" + IncrementDate(document.getElementById('start_date').value, i);
            row.appendChild(nameCell);
            let pButton = document.createElement('button');
            pButton.style.width = '20px';  // Ширина кнопки
            pButton.style.height = '20px'; // Высота кнопки
            pButton.style.fontSize = '12px'; // Размер шрифта
            pButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            pButton.innerHTML = "P";
            let kButton = document.createElement('button');
            kButton.style.width = '20px';  // Ширина кнопки
            kButton.style.height = '20px'; // Высота кнопки
            kButton.style.fontSize = '12px'; // Размер шрифта
            kButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            kButton.innerHTML = "K";
            let rButton = document.createElement('button');
            rButton.style.width = '20px';  // Ширина кнопки
            rButton.style.height = '20px'; // Высота кнопки
            rButton.style.fontSize = '12px'; // Размер шрифта
            rButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            rButton.innerHTML = "R";
            let cButton = document.createElement('button');
            cButton.style.width = '20px';  // Ширина кнопки
            cButton.style.height = '20px'; // Высота кнопки
            cButton.style.fontSize = '12px'; // Размер шрифта
            cButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            cButton.innerHTML = "C";
            
            if (state === "decrease" && date == global_date) {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type + "↓";
                } 
            } else if (state === "increase" && date == global_date) {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type + "↑";
                } 
            } else {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type;
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type;
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type;
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type;
                } 
                }

                pButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], pButton);

                if (this.innerHTML === "P") {
                    this.innerHTML = "P↓";
                    state = "decrease";
                } else if (this.innerHTML === "P↓") {
                    this.innerHTML = "P↑";
                    state = "increase";
                } else if (this.innerHTML === "P↑") {
                    this.innerHTML = "P";
                    state = null;
                }

                global_date = date;
                metric_type = "P";

                UpdateTable();
            });

            kButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], kButton);

                if (this.innerHTML === "K") {
                    this.innerHTML = "K↓";
                    state = "decrease";
                } else if (this.innerHTML === "K↓") {
                    this.innerHTML = "K↑";
                    state = "increase";
                } else if (this.innerHTML === "K↑") {
                    this.innerHTML = "K";
                    state = null;
                }

                global_date = date;
                metric_type = "K";

                UpdateTable();
            });

            rButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], rButton);

                if (this.innerHTML === "R") {
                    this.innerHTML = "R↓";
                    state = "decrease";
                } else if (this.innerHTML === "R↓") {
                    this.innerHTML = "R↑";
                    state = "increase";
                } else if (this.innerHTML === "R↑") {
                    this.innerHTML = "R";
                    state = null;
                }

                global_date = date;
                metric_type = "R";

                UpdateTable();
            });

            cButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], cButton);

                if (this.innerHTML === "C") {
                    this.innerHTML = "C↓";
                    state = "decrease";
                } else if (this.innerHTML === "C↓") {
                    this.innerHTML = "C↑";
                    state = "increase";
                } else if (this.innerHTML === "C↑") {
                    this.innerHTML = "C";
                    state = null;
                }

                global_date = date;
                metric_type = "C";

                UpdateTable();
            });

            // Функция для сброса состояния всех кнопок
            function resetButtons(buttons, activeButton) {
                state_type = "date";
                buttons.forEach(function(button) {
                    if (button !== activeButton) {
                        button.innerHTML = button.innerHTML.charAt(0); // Сброс до "P", "K", "R", "C"
                    }
                });
            }

            let buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex'; // Выравнивание кнопок в одну строку
            buttonContainer.style.gap = '5px'; // Расстояние между кнопками

            // Добавляем кнопки в контейнер
            buttonContainer.appendChild(pButton);
            buttonContainer.appendChild(kButton);
            buttonContainer.appendChild(rButton);
            buttonContainer.appendChild(cButton);

            nameCell.appendChild(buttonContainer);

            row.appendChild(nameCell);
        }

        // Удаление суммарных показателей если изменены даты или поисковое поле
        start_date_value = document.getElementById('start_date').value; // Дата начала поиска
        end_date_value = document.getElementById('end_date').value; // Дата окончания поиска    
        search_text_value = document.getElementById("search_field").value;
        if (start_date_value != prev_start_date || end_date_value!= prev_end_date || search_text_value!= prev_search_text) {
            var elmtTable = document.getElementById('thead_t');
            var rows = elmtTable.getElementsByTagName('tr');
            var rowCount = rows.length;
            for (var x = rowCount-1; x > 0; x--) {
                
                elmtTable.removeChild(rows[x]);
            }
            toggleDeleteGraph()
        }
        prev_start_date = document.getElementById('start_date').value;
        prev_end_date = document.getElementById('end_date').value;
        prev_search_text = document.getElementById("search_field").value;

        document.querySelector('#head_t td:first-child').textContent = `query`; // Обновляем текст, убираем количество записей после 'query'

        var CurPage = document.getElementById("cur").innerHTML;
        CurPage = Number.parseInt(CurPage, 10)
        var url = "{{ url_for('get_queries') }}";
        var params = {
            length: 50, // количество отображаемых элементов
            start: (CurPage - 1) * 50, // номер страницы
            start_date: document.getElementById('start_date').value, // Дата начала поиска
            end_date: document.getElementById('end_date').value, // Дата окончания поиска
            amount: calculateDays(),
            search_text: document.getElementById("search_field").value,
            sort_result: document.getElementById("input_sort").checked,
            sort_desc: document.getElementById("input_desc").checked,
            button_date: global_date,
            button_state: state,
            metric_type: metric_type,
            state_type: state_type,
        };

        fetch(url, {
            method: "POST",
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify(params)
            // body: formData
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                data = data.data;
                
                var table = $('#body_t');

                var elmtTable = document.getElementById('body_t');
                var tableRows = elmtTable.getElementsByTagName('tr');
                var rowCount = tableRows.length;

                for (var x = rowCount - 1; x >= 0; x--) {
                    elmtTable.removeChild(tableRows[x]);
                }
                if (data.length == 0) {
                    return;
                }
                empty = `<div style='height: 55px; width: 100px; margin: 0px; padding: 0px; background-color: #B9BDBC'>
            <span style='font-size: 18px'><span style='color:red'>NAN</span></span><br>
            <span style='font-size: 10px'>Клики</span><span style='font-size: 10px; margin-left: 10px'>CTR <span style='color:red'>NAN%</span></span><br>
            <span style='font-size: 10px'><span style='color:red'>NAN</span></span> <span style='font-size: 10px; margin-left: 30px'>R <span style='color:red'>NAN%</span></span>
            </div>`
                for (i = 0; i < 50; i++) {
                    var newRow = '<tr>';
                    $.each(columns, function (index_c, cell) {
                        if (data[i][columns[index_c]["title"]]) {
                            newRow += '<td>' + data[i][columns[index_c]["title"]] + '</td>';
                        } else {
                            newRow += '<td>' + empty + '</td>';
                        }
                    });
                    newRow += '</tr>';
                    table.append(newRow);
                }

            })
            .catch(error => {
                // Обработка ошибки
                console.error("Error:", error);
            });

    }


    function PrevPage() {

        let row = document.getElementById("head_t");
        row.innerHTML = "";
        var nameCell = document.createElement('td');
        nameCell.textContent = "query";
        row.appendChild(nameCell);
        var nameCell = document.createElement('td');
        nameCell.textContent = "result"; // Добавляем основной текст
        var lineBreak = document.createElement('br'); // Создаем элемент <br> для переноса строки
        nameCell.appendChild(lineBreak); // Добавляем перенос строки
        nameCell.appendChild(document.createTextNode("None")); // Добавляем текст "None"
        row.appendChild(nameCell); // Добавляем ячейку в строку

        let pButton = document.createElement('button');
            pButton.style.width = '20px';  // Ширина кнопки
            pButton.style.height = '20px'; // Высота кнопки
            pButton.style.fontSize = '12px'; // Размер шрифта
            pButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            pButton.innerHTML = "P";
            let kButton = document.createElement('button');
            kButton.style.width = '20px';  // Ширина кнопки
            kButton.style.height = '20px'; // Высота кнопки
            kButton.style.fontSize = '12px'; // Размер шрифта
            kButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            kButton.innerHTML = "K";
            let rButton = document.createElement('button');
            rButton.style.width = '20px';  // Ширина кнопки
            rButton.style.height = '20px'; // Высота кнопки
            rButton.style.fontSize = '12px'; // Размер шрифта
            rButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            rButton.innerHTML = "R";
            let cButton = document.createElement('button');
            cButton.style.width = '20px';  // Ширина кнопки
            cButton.style.height = '20px'; // Высота кнопки
            cButton.style.fontSize = '12px'; // Размер шрифта
            cButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            cButton.innerHTML = "C";

            if (state === "decrease" && state_type == "result") {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type + "↓";
                } 
            } else if (state === "increase" && state_type == "result") {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type + "↑";
                } 
            } else {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type;
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type;
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type;
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type;
                } 
                }

            pButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], pButton);
                state_type = "result";

                if (this.innerHTML === "P") {
                    this.innerHTML = "P↓";
                    state = "decrease";
                } else if (this.innerHTML === "P↓") {
                    this.innerHTML = "P↑";
                    state = "increase";
                } else if (this.innerHTML === "P↑") {
                    this.innerHTML = "P";
                    state = null;
                }

                metric_type = "P";

                UpdateTable();
            });

            kButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], kButton);
                state_type = "result";

                if (this.innerHTML === "K") {
                    this.innerHTML = "K↓";
                    state = "decrease";
                } else if (this.innerHTML === "K↓") {
                    this.innerHTML = "K↑";
                    state = "increase";
                } else if (this.innerHTML === "K↑") {
                    this.innerHTML = "K";
                    state = null;
                }

                metric_type = "K";

                UpdateTable();
            });

            rButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], rButton);
                state_type = "result";

                if (this.innerHTML === "R") {
                    this.innerHTML = "R↓";
                    state = "decrease";
                } else if (this.innerHTML === "R↓") {
                    this.innerHTML = "R↑";
                    state = "increase";
                } else if (this.innerHTML === "R↑") {
                    this.innerHTML = "R";
                    state = null;
                }

                metric_type = "R";

                UpdateTable();
            });

            cButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], cButton);
                state_type = "result";

                if (this.innerHTML === "C") {
                    this.innerHTML = "C↓";
                    state = "decrease";
                } else if (this.innerHTML === "C↓") {
                    this.innerHTML = "C↑";
                    state = "increase";
                } else if (this.innerHTML === "C↑") {
                    this.innerHTML = "C";
                    state = null;
                }

                metric_type = "C";

                UpdateTable();
            });

            let buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex'; // Выравнивание кнопок в одну строку
            buttonContainer.style.gap = '5px'; // Расстояние между кнопками

            // Добавляем кнопки в контейнер
            buttonContainer.appendChild(pButton);
            buttonContainer.appendChild(kButton);
            buttonContainer.appendChild(rButton);
            buttonContainer.appendChild(cButton);

// Добавляем контейнер в ячейку
            nameCell.appendChild(buttonContainer);

            row.appendChild(nameCell);

        columns = [
            {"title": "query"},
            {"title": "result"},
        ]

        amount = calculateDays();
        
        for (let i = amount; i >= 0; i--) {
            let date = IncrementDate(document.getElementById('start_date').value, i);
            columns.push({"title": date});
            let nameCell = document.createElement('td');
            nameCell.innerHTML = getDayOfWeek(IncrementDate(document.getElementById('start_date').value, i)) + "<br>" + IncrementDate(document.getElementById('start_date').value, i);
            row.appendChild(nameCell);
            let pButton = document.createElement('button');
            pButton.style.width = '20px';  // Ширина кнопки
            pButton.style.height = '20px'; // Высота кнопки
            pButton.style.fontSize = '12px'; // Размер шрифта
            pButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            pButton.innerHTML = "P";
            let kButton = document.createElement('button');
            kButton.style.width = '20px';  // Ширина кнопки
            kButton.style.height = '20px'; // Высота кнопки
            kButton.style.fontSize = '12px'; // Размер шрифта
            kButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            kButton.innerHTML = "K";
            let rButton = document.createElement('button');
            rButton.style.width = '20px';  // Ширина кнопки
            rButton.style.height = '20px'; // Высота кнопки
            rButton.style.fontSize = '12px'; // Размер шрифта
            rButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            rButton.innerHTML = "R";
            let cButton = document.createElement('button');
            cButton.style.width = '20px';  // Ширина кнопки
            cButton.style.height = '20px'; // Высота кнопки
            cButton.style.fontSize = '12px'; // Размер шрифта
            cButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            cButton.innerHTML = "C";
            
            if (state === "decrease" && date == global_date) {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type + "↓";
                } 
            } else if (state === "increase" && date == global_date) {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type + "↑";
                } 
            } else {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type;
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type;
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type;
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type;
                } 
                }

                pButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], pButton);

                if (this.innerHTML === "P") {
                    this.innerHTML = "P↓";
                    state = "decrease";
                } else if (this.innerHTML === "P↓") {
                    this.innerHTML = "P↑";
                    state = "increase";
                } else if (this.innerHTML === "P↑") {
                    this.innerHTML = "P";
                    state = null;
                }

                global_date = date;
                metric_type = "P";

                UpdateTable();
            });

            kButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], kButton);

                if (this.innerHTML === "K") {
                    this.innerHTML = "K↓";
                    state = "decrease";
                } else if (this.innerHTML === "K↓") {
                    this.innerHTML = "K↑";
                    state = "increase";
                } else if (this.innerHTML === "K↑") {
                    this.innerHTML = "K";
                    state = null;
                }

                global_date = date;
                metric_type = "K";

                UpdateTable();
            });

            rButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], rButton);

                if (this.innerHTML === "R") {
                    this.innerHTML = "R↓";
                    state = "decrease";
                } else if (this.innerHTML === "R↓") {
                    this.innerHTML = "R↑";
                    state = "increase";
                } else if (this.innerHTML === "R↑") {
                    this.innerHTML = "R";
                    state = null;
                }

                global_date = date;
                metric_type = "R";

                UpdateTable();
            });

            cButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], cButton);

                if (this.innerHTML === "C") {
                    this.innerHTML = "C↓";
                    state = "decrease";
                } else if (this.innerHTML === "C↓") {
                    this.innerHTML = "C↑";
                    state = "increase";
                } else if (this.innerHTML === "C↑") {
                    this.innerHTML = "C";
                    state = null;
                }

                global_date = date;
                metric_type = "C";

                UpdateTable();
            });

            // Функция для сброса состояния всех кнопок
            function resetButtons(buttons, activeButton) {
                state_type = "date";
                buttons.forEach(function(button) {
                    if (button !== activeButton) {
                        button.innerHTML = button.innerHTML.charAt(0); // Сброс до "P", "K", "R", "C"
                    }
                });
            }

            let buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex'; // Выравнивание кнопок в одну строку
            buttonContainer.style.gap = '5px'; // Расстояние между кнопками

            // Добавляем кнопки в контейнер
            buttonContainer.appendChild(pButton);
            buttonContainer.appendChild(kButton);
            buttonContainer.appendChild(rButton);
            buttonContainer.appendChild(cButton);

            nameCell.appendChild(buttonContainer);

            row.appendChild(nameCell);
        }
        var CurPage = document.getElementById("cur").innerHTML;
        CurPage = Number.parseInt(CurPage, 10)

        document.getElementById("prev").innerHTML = CurPage - 2;
        if (CurPage <= 2) {
            document.getElementById("prev").disabled = true;
        } else {
            document.getElementById("prev").disabled = false;
        }
        document.getElementById("cur").innerHTML = CurPage - 1;
        document.getElementById("next").innerHTML = CurPage;



        var url = "{{ url_for('get_queries') }}";
        var params = {
            length: 50, // количество отображаемых элементов
            start: ((CurPage - 2) * 50), // номер страницы
            start_date: document.getElementById('start_date').value, // Дата начала поиска
            end_date: document.getElementById('end_date').value, // Дата окончания поиска
            amount: calculateDays(),
            search_text: document.getElementById("search_field").value,
            sort_result: document.getElementById("input_sort").checked,
            sort_desc: document.getElementById("input_desc").checked,
            button_date: global_date,
            button_state: state,
            metric_type: metric_type,
            state_type: state_type,
        };

        fetch(url, {
            method: "POST",
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify(params)
            // body: formData
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                data = data.data;
                var table = $('#body_t');

                var elmtTable = document.getElementById('body_t');
                var tableRows = elmtTable.getElementsByTagName('tr');
                var rowCount = tableRows.length;

                for (var x = rowCount - 1; x >= 0; x--) {
                    elmtTable.removeChild(tableRows[x]);
                }
                if (data.length == 0) {
                    return;
                }
                empty = `<div style='height: 55px; width: 100px; margin: 0px; padding: 0px; background-color: #B9BDBC'>
            <span style='font-size: 18px'><span style='color:red'>NAN</span></span><br>
            <span style='font-size: 10px'>Клики</span><span style='font-size: 10px; margin-left: 10px'>CTR <span style='color:red'>NAN%</span></span><br>
            <span style='font-size: 10px'><span style='color:red'>NAN</span></span> <span style='font-size: 10px; margin-left: 30px'>R <span style='color:red'>NAN%</span></span>
            </div>`
                for (i = 0; i < 50; i++) {
                    var newRow = '<tr>';
                    $.each(columns, function (index_c, cell) {
                        if (data[i][columns[index_c]["title"]]) {
                            newRow += '<td>' + data[i][columns[index_c]["title"]] + '</td>';
                        } else {
                            newRow += '<td>' + empty + '</td>';
                        }
                    });
                    newRow += '</tr>';
                    table.append(newRow);
                }

            })
            .catch(error => {
                // Обработка ошибки
                console.error("Error:", error);
            });

    }


    function NextPage() {

        let row = document.getElementById("head_t");
        row.innerHTML = "";
        var nameCell = document.createElement('td');
        nameCell.textContent = "query";
        row.appendChild(nameCell);
        var nameCell = document.createElement('td');
        nameCell.textContent = "result"; // Добавляем основной текст
        var lineBreak = document.createElement('br'); // Создаем элемент <br> для переноса строки
        nameCell.appendChild(lineBreak); // Добавляем перенос строки
        nameCell.appendChild(document.createTextNode("None")); // Добавляем текст "None"
        row.appendChild(nameCell); // Добавляем ячейку в строку

        let pButton = document.createElement('button');
            pButton.style.width = '20px';  // Ширина кнопки
            pButton.style.height = '20px'; // Высота кнопки
            pButton.style.fontSize = '12px'; // Размер шрифта
            pButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            pButton.innerHTML = "P";
            let kButton = document.createElement('button');
            kButton.style.width = '20px';  // Ширина кнопки
            kButton.style.height = '20px'; // Высота кнопки
            kButton.style.fontSize = '12px'; // Размер шрифта
            kButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            kButton.innerHTML = "K";
            let rButton = document.createElement('button');
            rButton.style.width = '20px';  // Ширина кнопки
            rButton.style.height = '20px'; // Высота кнопки
            rButton.style.fontSize = '12px'; // Размер шрифта
            rButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            rButton.innerHTML = "R";
            let cButton = document.createElement('button');
            cButton.style.width = '20px';  // Ширина кнопки
            cButton.style.height = '20px'; // Высота кнопки
            cButton.style.fontSize = '12px'; // Размер шрифта
            cButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            cButton.innerHTML = "C";

            if (state === "decrease" && state_type == "result") {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type + "↓";
                } 
            } else if (state === "increase" && state_type == "result") {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type + "↑";
                } 
            } else {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type;
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type;
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type;
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type;
                } 
                }

            pButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], pButton);
                state_type = "result";

                if (this.innerHTML === "P") {
                    this.innerHTML = "P↓";
                    state = "decrease";
                } else if (this.innerHTML === "P↓") {
                    this.innerHTML = "P↑";
                    state = "increase";
                } else if (this.innerHTML === "P↑") {
                    this.innerHTML = "P";
                    state = null;
                }

                metric_type = "P";

                UpdateTable();
            });

            kButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], kButton);
                state_type = "result";

                if (this.innerHTML === "K") {
                    this.innerHTML = "K↓";
                    state = "decrease";
                } else if (this.innerHTML === "K↓") {
                    this.innerHTML = "K↑";
                    state = "increase";
                } else if (this.innerHTML === "K↑") {
                    this.innerHTML = "K";
                    state = null;
                }

                metric_type = "K";

                UpdateTable();
            });

            rButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], rButton);
                state_type = "result";

                if (this.innerHTML === "R") {
                    this.innerHTML = "R↓";
                    state = "decrease";
                } else if (this.innerHTML === "R↓") {
                    this.innerHTML = "R↑";
                    state = "increase";
                } else if (this.innerHTML === "R↑") {
                    this.innerHTML = "R";
                    state = null;
                }

                metric_type = "R";

                UpdateTable();
            });

            cButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], cButton);
                state_type = "result";

                if (this.innerHTML === "C") {
                    this.innerHTML = "C↓";
                    state = "decrease";
                } else if (this.innerHTML === "C↓") {
                    this.innerHTML = "C↑";
                    state = "increase";
                } else if (this.innerHTML === "C↑") {
                    this.innerHTML = "C";
                    state = null;
                }

                metric_type = "C";

                UpdateTable();
            });


            let buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex'; // Выравнивание кнопок в одну строку
            buttonContainer.style.gap = '5px'; // Расстояние между кнопками

            // Добавляем кнопки в контейнер
            buttonContainer.appendChild(pButton);
            buttonContainer.appendChild(kButton);
            buttonContainer.appendChild(rButton);
            buttonContainer.appendChild(cButton);

// Добавляем контейнер в ячейку
            nameCell.appendChild(buttonContainer);

            row.appendChild(nameCell);

        columns = [
            {"title": "query"},
            {"title": "result"},
        ]

        amount = calculateDays();

        for (let i = amount; i >= 0; i--) {
            let date = IncrementDate(document.getElementById('start_date').value, i);
            columns.push({"title": date});
            let nameCell = document.createElement('td');
            nameCell.innerHTML = getDayOfWeek(IncrementDate(document.getElementById('start_date').value, i)) + "<br>" + IncrementDate(document.getElementById('start_date').value, i);
            row.appendChild(nameCell);
            let pButton = document.createElement('button');
            pButton.style.width = '20px';  // Ширина кнопки
            pButton.style.height = '20px'; // Высота кнопки
            pButton.style.fontSize = '12px'; // Размер шрифта
            pButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            pButton.innerHTML = "P";
            let kButton = document.createElement('button');
            kButton.style.width = '20px';  // Ширина кнопки
            kButton.style.height = '20px'; // Высота кнопки
            kButton.style.fontSize = '12px'; // Размер шрифта
            kButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            kButton.innerHTML = "K";
            let rButton = document.createElement('button');
            rButton.style.width = '20px';  // Ширина кнопки
            rButton.style.height = '20px'; // Высота кнопки
            rButton.style.fontSize = '12px'; // Размер шрифта
            rButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            rButton.innerHTML = "R";
            let cButton = document.createElement('button');
            cButton.style.width = '20px';  // Ширина кнопки
            cButton.style.height = '20px'; // Высота кнопки
            cButton.style.fontSize = '12px'; // Размер шрифта
            cButton.style.padding = '2px 2px'; // Отступы внутри кнопки
            cButton.innerHTML = "C";
            
            if (state === "decrease" && date == global_date) {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type + "↓";
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type + "↓";
                } 
            } else if (state === "increase" && date == global_date) {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type + "↑";
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type + "↑";
                } 
            } else {
                if (metric_type == "P") {
                    pButton.innerHTML = metric_type;
                } else if (metric_type == "K") {
                    kButton.innerHTML = metric_type;
                } else if (metric_type == "R") {
                    rButton.innerHTML = metric_type;
                } else if (metric_type == "C") {
                    cButton.innerHTML = metric_type;
                } 
                }

                pButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], pButton);

                if (this.innerHTML === "P") {
                    this.innerHTML = "P↓";
                    state = "decrease";
                } else if (this.innerHTML === "P↓") {
                    this.innerHTML = "P↑";
                    state = "increase";
                } else if (this.innerHTML === "P↑") {
                    this.innerHTML = "P";
                    state = null;
                }

                global_date = date;
                metric_type = "P";

                UpdateTable();
            });

            kButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], kButton);

                if (this.innerHTML === "K") {
                    this.innerHTML = "K↓";
                    state = "decrease";
                } else if (this.innerHTML === "K↓") {
                    this.innerHTML = "K↑";
                    state = "increase";
                } else if (this.innerHTML === "K↑") {
                    this.innerHTML = "K";
                    state = null;
                }

                global_date = date;
                metric_type = "K";

                UpdateTable();
            });

            rButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], rButton);

                if (this.innerHTML === "R") {
                    this.innerHTML = "R↓";
                    state = "decrease";
                } else if (this.innerHTML === "R↓") {
                    this.innerHTML = "R↑";
                    state = "increase";
                } else if (this.innerHTML === "R↑") {
                    this.innerHTML = "R";
                    state = null;
                }

                global_date = date;
                metric_type = "R";

                UpdateTable();
            });

            cButton.addEventListener('click', function() {
                resetButtons([pButton, kButton, rButton, cButton], cButton);

                if (this.innerHTML === "C") {
                    this.innerHTML = "C↓";
                    state = "decrease";
                } else if (this.innerHTML === "C↓") {
                    this.innerHTML = "C↑";
                    state = "increase";
                } else if (this.innerHTML === "C↑") {
                    this.innerHTML = "C";
                    state = null;
                }

                global_date = date;
                metric_type = "C";

                UpdateTable();
            });

            // Функция для сброса состояния всех кнопок
            function resetButtons(buttons, activeButton) {
                state_type = "date";
                buttons.forEach(function(button) {
                    if (button !== activeButton) {
                        button.innerHTML = button.innerHTML.charAt(0); // Сброс до "P", "K", "R", "C"
                    }
                });
            }

            let buttonContainer = document.createElement('div');
            buttonContainer.style.display = 'flex'; // Выравнивание кнопок в одну строку
            buttonContainer.style.gap = '5px'; // Расстояние между кнопками

            // Добавляем кнопки в контейнер
            buttonContainer.appendChild(pButton);
            buttonContainer.appendChild(kButton);
            buttonContainer.appendChild(rButton);
            buttonContainer.appendChild(cButton);

            nameCell.appendChild(buttonContainer);

            row.appendChild(nameCell);
        }
        var CurPage = document.getElementById("cur").innerHTML;
        CurPage = Number.parseInt(CurPage, 10)
        var url = "{{ url_for('get_queries') }}";

        document.getElementById("prev").innerHTML = CurPage;
        document.getElementById("prev").disabled = false;
        document.getElementById("cur").innerHTML = CurPage + 1;
        document.getElementById("next").innerHTML = CurPage + 2;


        var params = {
            length: 50, // количество отображаемых элементов
            start: (CurPage * 50), // номер страницы
            start_date: document.getElementById('start_date').value, // Дата начала поиска
            end_date: document.getElementById('end_date').value, // Дата окончания поиска
            amount: calculateDays(),
            search_text: document.getElementById("search_field").value,
            sort_result: document.getElementById("input_sort").checked,
            sort_desc: document.getElementById("input_desc").checked,
            button_date: global_date,
            button_state: state,
            metric_type: metric_type,
            state_type: state_type,
        };

        fetch(url, {
            method: "POST",
            headers: {
                "Content-type": "application/json"
            },
            body: JSON.stringify(params)
            // body: formData
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);
                data = data.data;
                var table = $('#body_t');

                var elmtTable = document.getElementById('body_t');
                var tableRows = elmtTable.getElementsByTagName('tr');
                var rowCount = tableRows.length;

                for (var x = rowCount - 1; x >= 0; x--) {
                    elmtTable.removeChild(tableRows[x]);
                }
                if (data.length == 0) {
                    return;
                }
                empty = `<div style='height: 55px; width: 100px; margin: 0px; padding: 0px; background-color: #B9BDBC'>
            <span style='font-size: 18px'><span style='color:red'>NAN</span></span><br>
            <span style='font-size: 10px'>Клики</span><span style='font-size: 10px; margin-left: 10px'>CTR <span style='color:red'>NAN%</span></span><br>
            <span style='font-size: 10px'><span style='color:red'>NAN</span></span> <span style='font-size: 10px; margin-left: 30px'>R <span style='color:red'>NAN%</span></span>
            </div>`
                for (i = 0; i < 50; i++) {
                    var newRow = '<tr>';
                    $.each(columns, function (index_c, cell) {
                        if (data[i][columns[index_c]["title"]]) {
                            newRow += '<td>' + data[i][columns[index_c]["title"]] + '</td>';
                        } else {
                            newRow += '<td>' + empty + '</td>';
                        }
                    });
                    newRow += '</tr>';
                    table.append(newRow);
                }

            })
            .catch(error => {
                // Обработка ошибки
                console.error("Error:", error);
            });

    }

    $(document).ready(SetDatePage())
    $(document).ready(SetDataTable())
</script>
<div class="loader" style="display: none;"></div>
<script>
    function generateExcel(url_f) {
    $('.loader').show();
    const data = {
            length: 50, // количество отображаемых элементов
            start: 0, // номер страницы
            start_date: document.getElementById('start_date').value, // Дата начала поиска
            end_date: document.getElementById('end_date').value, // Дата окончания поиска
            amount: calculateDays(),
            search_text: document.getElementById("search_field").value,
            sort_result: document.getElementById("input_sort").checked,
            sort_desc: document.getElementById("input_desc").checked,
            button_date: global_date,
            button_state: state,
            metric_type: metric_type,
            state_type: state_type,
            list_name: "{{ list_name }}",
        };

    fetch(url_f, {
        method: 'POST',
        headers: {
            "Content-Type": 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok.');
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'query.xlsx';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        $('.loader').hide();
    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
        document.getElementById('loader').style.display = 'none';
        $('.loader').hide();
    });
}

    function getTotalSum(url_f) {
    $('.loader').show();
    //var url = "{{ url_for('get_total_sum') }}";
    var params = {
            start_date: prev_start_date,
            end_date: prev_end_date,
            search_text: prev_search_text
        };

    fetch(url_f, {
        method: "POST",
        headers: {
            "Content-type": "application/json"
        },
        body: JSON.stringify(params)
        // body: formData
    })
        .then(response => response.json())
        .then(data => {

            var clicks = data.clean_data[0];
            var impressions = data.clean_data[1];
            var not_void = data.clean_data[2];
            var top_3 = data.clean_data[3];
            var top_5 = data.clean_data[4];
            var top_10 = data.clean_data[5];

            var average_clicks = data.trendline_data[0];
            var average_impressions = data.trendline_data[1];
            var average_not_void = data.trendline_data[2];
            var average_top_3 = data.trendline_data[3];
            var average_top_5 = data.trendline_data[4];
            var average_top_10 = data.trendline_data[5];

            var dates = Object.keys(clicks); // Получаем даты для оси X

            // Вызываем функцию для отрисовки графиков
            toggleOnGraph();
            //const showTrendline = document.getElementById('showTrendline').checked;
            renderChart(dates, clicks, impressions, not_void, top_3, top_5, top_10,
                        average_clicks, average_impressions, average_not_void, average_top_3, average_top_5, average_top_10);
            console.log(data);
            metricks_data = data.metricks_data;
            var totalRecords = data.total_records; // Получаем общее количество записей
            document.querySelector('#head_t td:first-child').textContent = `query (${totalRecords})`; // Обновляем текст

            var table = $('#thead_t')
            var elmtTable = document.getElementById('thead_t');
            var rows = elmtTable.getElementsByTagName('tr');
            var rowCount = rows.length;
            for (var x = rowCount - 1; x > 0; x--) {

                elmtTable.removeChild(rows[x]);
            }
            
            var empty = `<div style='height: 55px; width: 100px; margin: 0px; padding: 0px; background-color: #B9BDBC;
                text-align: center; display: flex; align-items: center; justify-content: center;'>
                <span style='font-size: 18px'><span style='color:red'>NAN</span></span><br>
            </div>`;
            var zero = `<div style='height: 55px; width: 100px; margin: 0px; padding: 0px; background-color: #B9BDBC;
                text-align: center; display: flex; align-items: center; justify-content: center;'>
                <span style='font-size: 18px'><span style='color:red'>0.0</span></span><br>
            </div>`;
            // Обновляем таблицу с новыми данными
            for (var i = 0; i < metricks_data.length; i++) {
                var newRow = '<tr>';
                $.each(columns, function (index_c, cell) {
                    var cell_data = metricks_data[i][columns[index_c]["title"]];
                    if (cell_data) {
                        if (cell_data != "0") {
                            newRow += '<td>' + cell_data + '</td>';
                        } else {
                            newRow += '<td>' + zero + '</td>';
                        }
                    } else {
                        newRow += '<td>' + empty + '</td>';
                    }
                });
                newRow += '</tr>';
                table.append(newRow);
            }
            $('.loader').hide();
        })
        .catch(error => {
            // Обработка ошибки
            console.error('There was a problem with the fetch operation:', error);
            document.getElementById('loader').style.display = 'none';
            $('.loader').hide();
        });
    }
// Функция для показа или скрытия графика
function toggleGraph() {
    const chartContainer = document.getElementById('myChart');
    const hideGraphBtn = document.getElementById('hideGraphBtn');
    //const InterpolationCheckbox = document.getElementById('Interpolation');
    if (chartContainer.style.display === 'none') {
        chartContainer.style.display = 'block';
        hideGraphBtn.value = "Скрыть график";
        //InterpolationCheckbox.style.display = 'block';
    } else {
        chartContainer.style.display = 'none';
        hideGraphBtn.value = "Показать график";
        //InterpolationCheckbox.style.display = 'none';
    }
}

// Функция для показа
function toggleOnGraph() {
    const chartContainer = document.getElementById('myChart');
    const hideGraphBtn = document.getElementById('hideGraphBtn');
    //const InterpolationCheckbox = document.getElementById('Interpolation');
    chartContainer.style.display = 'block';
    hideGraphBtn.value = "Скрыть график";
    hideGraphBtn.style.display = 'block';
    //InterpolationCheckbox.style.display = 'block';   
}

// Функция для скрытия графика
function toggleOffGraph() {
    const chartContainer = document.getElementById('myChart');
    const hideGraphBtn = document.getElementById('hideGraphBtn');
    //const InterpolationCheckbox = document.getElementById('Interpolation');
    chartContainer.style.display = 'none';
    hideGraphBtn.style.display = 'block';
    hideGraphBtn.value = "Показать график";
    //InterpolationCheckbox.style.display = 'none';
}

// Функция для скрытия графика и кнопки показа графика
function toggleDeleteGraph() {
    const chartContainer = document.getElementById('myChart');
    const hideGraphBtn = document.getElementById('hideGraphBtn');
    //const InterpolationCheckbox = document.getElementById('Interpolation');
    chartContainer.style.display = 'none';
    hideGraphBtn.style.display = 'none';
    //InterpolationCheckbox.style.display = 'none';
}
// Функция для создания конфигурации графика
function createDataset(label, data, borderColor, showTrend = false) {
    return {
        label: label,
        data: Object.values(data),
        borderColor: borderColor,
        fill: false,
        pointRadius: 2,
        pointHoverRadius: 4,
        pointStyle: showTrend ? false : 'circle',
        cubicInterpolationMode: 'monotone',
        borderWidth: showTrend ? 1 : 3,  // Трендовые данные с меньшей толщиной линии
        hidden: showTrend  // По умолчанию тренды скрыты
    };
}

// Функция для отрисовки графиков
function renderChart(dates, clicks, impressions, not_void, 
                    top_3, top_5, top_10,
                    average_clicks, average_impressions, average_not_void, 
                    average_top_3, average_top_5, average_top_10) {
    var ctx = document.getElementById('myChart').getContext('2d');
    // Если график уже существует, уничтожаем его перед созданием нового
    if (chartInstance) {
        chartInstance.destroy();
    }
    //let datasets = []
    

    // Основные метрики
    const datasets = [
        createDataset('Impressions', impressions, 'rgb(54, 162, 235)'),
        createDataset('Clicks', clicks, 'rgb(255, 99, 132)'),
        createDataset('Top 50 Rows', not_void, 'rgb(75, 192, 192)'),
        createDataset('Top 10 Rows', top_10, 'rgb(255, 159, 64)'),
        createDataset('Top 5 Rows', top_5, 'rgb(153, 102, 255)'),
        createDataset('Top 3 Rows', top_3, 'rgb(255, 216, 106)'),
    ];

    // Трендовые метрики
    const trendDatasets = [
        createDataset('Impressions trend', average_impressions, 'rgb(54, 162, 235)', true),
        createDataset('Clicks trend', average_clicks, 'rgb(255, 99, 132)', true),
        createDataset('Top 50 Rows trend', average_not_void, 'rgb(75, 192, 192)', true),
        createDataset('Top 10 Rows trend', average_top_10, 'rgb(255, 159, 64)', true),
        createDataset('Top 5 Rows trend', average_top_5, 'rgb(153, 102, 255)', true),
        createDataset('Top 3 Rows trend', average_top_3, 'rgb(255, 216, 106)', true),
    ];

    // Объединение всех данных
    const allDatasets = datasets.concat(trendDatasets);
    let allHidden = false;
    chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
            labels: dates,
            datasets: allDatasets,
        },
        options: {
            responsive: true,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            stacked: false,
            scales: {
                y: {
                    beginAtZero: true,
                    type: 'linear',
                    display: true,
                    position: 'left',
                }
            },
            plugins: {
                    legend: {
                        display: true,
                        // Настройка функции, которая перехватывает клики по легенде
                        onClick: (e, legendItem, legend) => {
                            const datasetIndex = legendItem.datasetIndex;
                            const chart = legend.chart;
                            const dataset = chart.data.datasets[datasetIndex];

                            // Переключаем видимость датасета
                            dataset.hidden = !dataset.hidden;
                            chart.update();
                        },
                        labels: {
                            generateLabels: (chart) => {
                                const datasets = chart.data.datasets;
                                const pairedLegendItems = [];

                                // Создаем метки парами для основной метрики и тренда
                                for (let i = 0; i < datasets.length / 2; i++) {
                                    pairedLegendItems.push({
                                        text: datasets[i].label,
                                        fillStyle: datasets[i].borderColor,
                                        strokeStyle: 'BLACK',
                                        lineCap: 'round',
                                        hidden: datasets[i].hidden,
                                        datasetIndex: i,
                                    });
                                    pairedLegendItems.push({
                                        text: datasets[i + datasets.length / 2].label,
                                        fillStyle: datasets[i + datasets.length / 2].borderColor,
                                        strokeStyle: datasets[i + datasets.length / 2].borderColor,
                                        lineCap: 'round',
                                        hidden: datasets[i + datasets.length / 2].hidden,
                                        datasetIndex: i + datasets.length / 2,
                                    });
                                }

                                // Добавляем кастомную кнопку в легенду с черной рамкой
                                pairedLegendItems.push({
                                    text: allHidden ? 'Show All' : 'Hide All',
                                    fillStyle: 'rgba(0, 0, 0, 0)', // Прозрачный фон
                                    strokeStyle: 'black', // Черная рамка
                                    hidden: false,
                                    datasetIndex: null, // Это не датасет
                                    isCustom: true, // Пользовательская кнопка
                                });

                                return pairedLegendItems;
                            },
                        },
                        onClick: (e, legendItem, legend) => {
                            const chart = legend.chart;

                            // Если это не кастомная кнопка, стандартное поведение
                            if (!legendItem.isCustom) {
                                const datasetIndex = legendItem.datasetIndex;
                                const dataset = chart.data.datasets[datasetIndex];
                                dataset.hidden = !dataset.hidden;
                                chart.update();
                            } else {
                                // Логика для кастомной кнопки (Hide All / Show All)
                                allHidden = !allHidden;
                                chart.data.datasets.forEach((dataset) => {
                                    dataset.hidden = allHidden;
                                });
                                chart.update();
                            }
                        }
                    }
                }
        }
    });
}
function generateCsv(url_f) {
    $('.loader').show();
    const data = {
            length: 50, // количество отображаемых элементов
            start: 0, // номер страницы
            start_date: document.getElementById('start_date').value, // Дата начала поиска
            end_date: document.getElementById('end_date').value, // Дата окончания поиска
            amount: calculateDays(),
            search_text: document.getElementById("search_field").value,
            sort_result: document.getElementById("input_sort").checked,
            sort_desc: document.getElementById("input_desc").checked,
            button_date: global_date,
            button_state: state,
            metric_type: metric_type,
            state_type: state_type,
            list_name: "{{ list_name }}",
        };

    fetch(url_f, {
        method: 'POST',
        headers: {
            "Content-Type": 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok.');
        }
        return response.blob();
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'query.csv';
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        $('.loader').hide();
    })
    .catch(error => {
        console.error('There was a problem with the fetch operation:', error);
        document.getElementById('loader').style.display = 'none';
        $('.loader').hide();
    });
}

function sendRequest(url) {
    $('.loader').show();
    fetch(url)
        .then(response => {
            // Проверяем статус ответа
            if (!response.ok) {
                return response.json().then(errData => {
                    // Обработка ошибки в зависимости от статуса
                    if (response.status === 400) {
                        throw new Error(errData.detail || 'Bad Request');
                    }
                });
            }
            return response.json();  // Если статус успешный, возвращаем JSON
        })
        .then(data => {
            console.log('Success:', data);
            // Обработка успешного ответа
            $('.loader').hide();
            alert(data.message)
            window.location.reload();  // Обновление страницы
        })
        .catch((error) => {
            alert(error.message);
            // Обработка ошибки
            $('.loader').hide();
        });
}

    async function deleteDataForLast(url) {
            // Получить значение из поля ввода
            const days = document.getElementById('days').value;

            // Проверка корректности значения
            if (days < 1 || days > 13) {
                alert("Incorrect value (1-13)");
                return;
            }

            // Запрос подтверждения удаления
            const confirmation = prompt(`Для подтверждения удаления данных за ${days} дней введите 'delete':`);
            if (confirmation !== 'delete') {
                alert('Удаление отменено.');
                return;
            }

            if (days) {
                try {
                    const response = await fetch(`${url}?days=${days}`, {
                        method: 'DELETE',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });

                    if (response.ok) {
                        // Запрос выполнен успешно
                        const result = await response.json();
                        window.location.reload();
                    } else {
                        // Обработка ошибки сервера
                        const errorData = await response.json();
                        alert('Error: ' + errorData.detail);
                    }
                } catch (error) {
                    // Обработка ошибки запроса
                    console.error('Error during delete request:', error);
                    alert('An error occurred during the delete request. Please try again.');
                }
            } else {
                alert('Please enter a number of days.');
            }
        }
</script>

</body>
</html>
{% endblock %}